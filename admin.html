<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - 6Lottery</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            margin: 100px auto;
        }

        .login-box h2 {
            text-align: center;
            color: #1e3c72;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .error-msg {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
            display: none;
        }

        .admin-panel {
            display: none;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #1e3c72;
        }

        .logout-btn {
            padding: 10px 25px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h3 {
            color: #1e3c72;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn-primary {
            background: #2ecc71;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary:hover {
            background: #27ae60;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background: #f8f9fa;
            color: #1e3c72;
            font-weight: bold;
        }

        .btn-edit {
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 12px;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            padding: 5px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .device-info {
            font-size: 12px;
            color: #666;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 15px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            cursor: pointer;
            font-size: 24px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Admin Login -->
        <div class="login-box" id="adminLoginBox">
            <h2>üîê Admin Dashboard</h2>
            <div class="input-group">
                <label>Admin Password</label>
                <input type="password" id="adminPasswordInput" placeholder="Enter admin password" />
            </div>
            <button class="btn" onclick="adminLogin()">Login</button>
            <div class="error-msg" id="adminErrorMsg"></div>
        </div>

        <!-- Admin Panel -->
        <div class="admin-panel" id="adminPanel">
            <div class="header">
                <h1>üé∞ Admin Dashboard</h1>
                <button class="logout-btn" onclick="adminLogout()">Logout</button>
            </div>

            <div class="dashboard-grid">
                <!-- Create New Password -->
                <div class="card">
                    <h3>‚ûï Create New Password</h3>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="text" id="newPassword" placeholder="Enter new password" />
                    </div>
                    <div class="form-group">
                        <label>Device Limit</label>
                        <input type="number" id="deviceLimit" value="1" readonly />
                    </div>
                    <button class="btn-primary" onclick="createPassword()">Create Password</button>
                    <div class="success-msg" id="createSuccessMsg">Password created successfully!</div>
                </div>

                <!-- Statistics -->
                <div class="card">
                    <h3>üìä Statistics</h3>
                    <div style="padding: 20px 0;">
                        <p style="margin-bottom: 15px;">
                            <strong>Total Passwords:</strong> <span id="totalPasswords">0</span>
                        </p>
                        <p style="margin-bottom: 15px;">
                            <strong>Active Sessions:</strong> <span id="activeSessions">0</span>
                        </p>
                        <p>
                            <strong>Total Users:</strong> <span id="totalUsers">0</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Password List -->
            <div class="card">
                <h3>üîë User Passwords Management</h3>
                <table id="passwordsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Password</th>
                            <th>Device ID</th>
                            <th>IP Address</th>
                            <th>Last Login</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="passwordsTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Active Sessions -->
            <div class="card" style="margin-top: 20px;">
                <h3>üë• Active Sessions</h3>
                <table id="sessionsTable">
                    <thead>
                        <tr>
                            <th>Session ID</th>
                            <th>Password</th>
                            <th>Device ID</th>
                            <th>IP Address</th>
                            <th>Login Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Password Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Password</h3>
                <span class="close-modal" onclick="closeEditModal()">&times;</span>
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="text" id="editPasswordInput" />
            </div>
            <button class="btn-primary" onclick="savePasswordEdit()">Save Changes</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zrjfyaloaicrvkcfkpxf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyamZ5YWxvYWljcnZrY2ZrcHhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MDAyOTAsImV4cCI6MjA3NTk3NjI5MH0.JszbKpjiP-jYgAthvdHBIn1atsFC5fs6SYIqssoN7cc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentEditId = null;

        // Admin Login
        async function adminLogin() {
            const password = document.getElementById('adminPasswordInput').value;
            const errorMsg = document.getElementById('adminErrorMsg');

            const { data: admin } = await supabase
                .from('admin_users')
                .select('*')
                .eq('password', password)
                .single();

            if (!admin) {
                errorMsg.textContent = 'Invalid admin password';
                errorMsg.style.display = 'block';
                return;
            }

            localStorage.setItem('adminLoggedIn', 'true');
            document.getElementById('adminLoginBox').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';

            loadDashboard();
        }

        // Admin Logout
        function adminLogout() {
            localStorage.removeItem('adminLoggedIn');
            document.getElementById('adminLoginBox').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminPasswordInput').value = '';
        }

        // Create Password
        async function createPassword() {
            const password = document.getElementById('newPassword').value;
            const successMsg = document.getElementById('createSuccessMsg');

            if (!password) {
                alert('Please enter a password');
                return;
            }

            const { error } = await supabase
                .from('user_passwords')
                .insert({
                    password: password,
                    device_limit: 1
                });

            if (error) {
                alert('Error creating password: ' + error.message);
                return;
            }

            document.getElementById('newPassword').value = '';
            successMsg.style.display = 'block';
            setTimeout(() => successMsg.style.display = 'none', 3000);

            loadDashboard();
        }

        // Load Dashboard
        async function loadDashboard() {
            // Load statistics
            const { data: passwords } = await supabase
                .from('user_passwords')
                .select('*');

            const { data: sessions } = await supabase
                .from('user_sessions')
                .select('*')
                .eq('is_active', true);

            document.getElementById('totalPasswords').textContent = passwords?.length || 0;
            document.getElementById('activeSessions').textContent = sessions?.length || 0;
            document.getElementById('totalUsers').textContent = passwords?.filter(p => p.device_id).length || 0;

            // Load passwords table
            loadPasswordsTable();
            loadSessionsTable();
        }

        // Load Passwords Table
        async function loadPasswordsTable() {
            const { data: passwords } = await supabase
                .from('user_passwords')
                .select('*')
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('passwordsTableBody');
            tbody.innerHTML = '';

            passwords?.forEach(pwd => {
                const row = document.createElement('tr');
                const isActive = pwd.device_id ? 'active' : 'inactive';
                
                row.innerHTML = `
                    <td>${pwd.id}</td>
                    <td><strong>${pwd.password}</strong></td>
                    <td class="device-info">${pwd.device_id ? pwd.device_id.substring(0, 20) + '...' : '-'}</td>
                    <td>${pwd.ip_address || '-'}</td>
                    <td>${pwd.last_login ? new Date(pwd.last_login).toLocaleString() : '-'}</td>
                    <td><span class="status-badge status-${isActive}">${isActive}</span></td>
                    <td>
                        <button class="btn-edit" onclick="editPassword(${pwd.id}, '${pwd.password}')">Edit</button>
                        <button class="btn-delete" onclick="deletePassword(${pwd.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load Sessions Table
        async function loadSessionsTable() {
            const { data: sessions } = await supabase
                .from('user_sessions')
                .select(`
                    *,
                    user_passwords (password)
                `)
                .eq('is_active', true)
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('sessionsTableBody');
            tbody.innerHTML = '';

            sessions?.forEach(session => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${session.id}</td>
                    <td><strong>${session.user_passwords?.password || '-'}</strong></td>
                    <td class="device-info">${session.device_id.substring(0, 20)}...</td>
                    <td>${session.ip_address}</td>
                    <td>${new Date(session.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn-delete" onclick="terminateSession(${session.id})">Terminate</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Edit Password
        function editPassword(id, currentPassword) {
            currentEditId = id;
            document.getElementById('editPasswordInput').value = currentPassword;
            document.getElementById('editModal').style.display = 'block';
        }

        // Save Password Edit
        async function savePasswordEdit() {
            const newPassword = document.getElementById('editPasswordInput').value;

            if (!newPassword) {
                alert('Please enter a password');
                return;
            }

            // Update password
            const { error } = await supabase
                .from('user_passwords')
                .update({ password: newPassword })
                .eq('id', currentEditId);

            if (error) {
                alert('Error updating password');
                return;
            }

            // Terminate all sessions for this password
            await supabase
                .from('user_sessions')
                .update({ is_active: false })
                .eq('password_id', currentEditId);

            closeEditModal();
            loadDashboard();
        }

        // Close Edit Modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditId = null;
        }

        // Delete Password
        async function deletePassword(id) {
            if (!confirm('Are you sure you want to delete this password?')) {
                return;
            }

            // Terminate all sessions
            await supabase
                .from('user_sessions')
                .update({ is_active: false })
                .eq('password_id', id);

            // Delete password
            await supabase
                .from('user_passwords')
                .delete()
                .eq('id', id);

            loadDashboard();
        }

        // Terminate Session
        async function terminateSession(sessionId) {
            await supabase
                .from('user_sessions')
                .update({ is_active: false })
                .eq('id', sessionId);

            loadDashboard();
        }

        // Auto refresh
        setInterval(loadDashboard, 5000);

        // Check admin login on load
        window.onload = function() {
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                document.getElementById('adminLoginBox').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadDashboard();
            }
        };
    </script>
</body>
</html>
